
# Understanding Systemd
Systemd is started as the first process after loading the kernel and is the manager of everything! It is used for starting services like the secure shell server.  Apart from services, systemd takes care of many more items. The items started by systemd are referred to as **units**. **Systemctl** is the main management tool for systemd.

### Systemd Unit Locations 

| Location                | Description      |Precedence If Duplicates Exist |
| ----------------------- | ------------------------------------------------------------------------------------------------------------------------------------- | --- | 
| /usr/lib/systemd/system | Contains defaults unit files that have been installed from RPM packages. DO NOT EDIT THIS DIRECTLY   | 3    |   
| /etc/systemd/system     | Contains custom unit files. May also include files that have been written by an admin or generated by the **systemctl edit** command. |2     
| /run/systemd            | Contains unit files that have automatically been generated.                                                                           |    1 |       


## Service Units
Service units are used to start processes. 

| Section | Explanation |
| ------- | ----------- |
| Unit    | Describes the unit and defines dependencies. This section also contains the important After statement and optionally the Before statement. These statements define dependencies between different units, and they relate to the perspective of this unit. The Before statement indicates that this unit should be started before the unit that is specified. The After statement indicates that this unit should be started after the unit that is specified.            |
| Service |    Describes how to start and stop the service and request status installation. Normally, you can expect an ExecStart line, which indicates how to start the unit, or an ExecStop line, which indicates how to stop the unit. Note the Type option, which is used to specify how the process should start.          |
| Install        | Indicates in which target this unit has to be started.             |

```bash
/usr/lib/systemd/system/vsftpd.service
[Unit]
Description=Vsftpd ftp daemon
After=network.target

[Service]
Type=forking
ExecStart=/usr/sbin/vsftpd /etc/vsftpd/vsftpd.conf

[Install]
WantedBy=multi-user.target


```


### Systemd Mount Units
A mount unit specifies how a file system can be mounted on a specific directory. 
| Section | Explanation                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| ------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Unit    | The Conflicts statement is used to list units that cannot be used together with this unit. Use this statement for mutually exclusive units.|
| Mount   | This section defines exactly where the mount has to be performed. Here you see the arguments that are typically used in any mount command.            |

```bash
[Unit]
Description=Temporary Directory (/tmp)
Documentation=man:hier(7)
Documentation=https://www.freedesktop.org/wiki/Software/systemd/
APIFileSystems
ConditionPathIsSymbolicLink=!/tmp
DefaultDependencies=no
Conflicts=umount.target
Before=local-fs.target umount.target
After=swap.target

[Mount]
What=tmpfs
Where=/tmp
Type=tmpfs
Options=mode=1777,strictatime,nosuid,nodev
```


### Systemd Socket Units|                                                                                                                                                                                                                                                                                                                                                                                                                                                              
A socket creates a method for applications to communicate with one another.  Every socket needs a corresponding service file. 

```bash
[Unit]
Description=Cockpit Web Service Socket
Documentation=man:cockpit-ws(8)
Wants=cockpit-motd.service

[Socket]
# Port to listen on for incoming connections.
ListenStream=9090
ExecStartPost=-/usr/share/cockpit/motd/update-motd '' localhost
ExecStartPost=-/bin/ln -snf active.motd /run/cockpit/motd
ExecStopPost=-/bin/ln -snf /usr/share/cockpit/motd/inactive.motd
/run/cockpit/motd

[Install]
WantedBy=sockets.target
```


### Systemd Target Units

Target units are used to load unit files in the right order at the right moment.  A target unit  is a group of units. 

```bash

[Unit]
Description=Multi-User System
Documentation=man:systemd.special(7)
Requires=basic.target
Conflicts=rescue.service rescue.target
#After specifies load ordering. 
After=basic.target rescue.service rescue.target
AllowIsolate=yes

[Install]
Alias=default.target”

#The target file does not contain any information about the units that should be included; that is defined in the [Install] section of the different unit files.



```


When administrators use the systemctl enable command, to ensure that a unit is automatically started while booting, the [Install] section of that unit is considered to determine to which target the unit should be added.

# Managing Units Through Systemd
 The main ways to manage a unit are to **status**, start, **stop**, **enable**, or **disable** it.  Example of  seeing the status of sshd.

```bash
root@RHCSA-MAIN etc]# systemctl status sshd
● sshd.service - OpenSSH server daemon
     Loaded: loaded (/usr/lib/systemd/system/sshd.service; enabled; vendor preset: enabled)
     Active: active (running) since Mon 2022-07-18 12:59:35 EDT; 2 weeks 1 day ago
       Docs: man:sshd(8)
             man:sshd_config(5)
   Main PID: 929 (sshd)
      Tasks: 1 (limit: 22993)
     Memory: 2.9M
        CPU: 18ms
     CGroup: /system.slice/sshd.service
             └─929 "sshd: /usr/sbin/sshd -D [listener] 0 of 10-100 startups"
```

### Managing Dependencies

To see a list of dependencies for a unit, run `systemctl list-dependencies {unit name}` 
There are 2 ways to manage systemd dependencies:

1. Unit types such as socket and path are directly related to a service unit. Accessing either of these unit types will automatically trigger the service type.
2. Dependencies can be defined within the unit, using keywords like Requires, Requisite, After, and Before.


To ensure accurate dependency management, you can use different keywords in the [Unit] section of a unit:

- `Requires`: If this unit loads, units listed here will load also. If one of the other units is deactivated, this unit will also be deactivated.
- `Requisite`: If the unit listed here is not already loaded, this unit will fail.
- `Wants`: This unit wants to load the units that are listed here, but it will not fail if any of the listed units fail.
- `Before`: This unit will start before the unit specified with Before.
- ` After`: This unit will start after the unit specified with After.

### Managing Unit Options
Every unit file can be configured with different options. To figure out which options are available for a specific unit, use the `systemctl show` command.  The recommended way to change unit files to apply options is to use the `systemctl edit {service}` command. This command creates a subdirectory in `/etc/systemd/system` for the service that you are editing; for example, if you use `systemctl edit sshd.service`, you get a directory with the name `/etc/systemd/systemd/sshd.service.d` in which a file with the name override.conf is created. All settings that are applied in this file overwrite any existing settings in the service file in `/usr/lib/systemd/system`.

##### Example
Lets say we want to edit the httpd service so that on failue, it will continue after 1 minute.

`systemctl edit httpd`
![[Screenshot 2022-11-22 at 7.42.20 PM.png]]